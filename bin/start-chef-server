#!/bin/bash

if [ $# -eq 0 ]
then

    echo Removing server PID that might have been left in place on the last shutdown ...
    rm -fv /opt/opscode/embedded/service/oc_id/tmp/pids/server.pid

    echo Running Chef Server bootstrapper ...
    /opt/opscode/embedded/bin/runsvdir-start &

    if [ -f /etc/opscode/chef-server-running.json ]; then
        echo Starting Chef Server ...
        chef-server-ctl start
    else
        echo Building complete Chef Server ...
        . create-chef-server-configuration
        chef-server-ctl reconfigure
    fi

    # Set up to kill tail process in response to docker stop
    trap "pkill tail" SIGTERM

    echo Tailing Chef Server logs ...
    tail -f /var/log/opscode/*/current

    echo Gracefully stopping Chef Server ...
    chef-server-ctl stop

else

    exec "$@"

fi
